<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Installing custom Linux on Raspberry&nbsp;Pi&nbsp;2 - Igor \"ajgon\" Rzegocki</title>
  <meta name="description" content="Few days ago, I gave myself a present, which (at the very beginning) I was planning to powerup with OSMC and use it as HTPC. However, in a meantime I had to ...">

  
  <meta content="/assets/covers/installing-custom-linux-on-raspberry-pi-2.jpg" name="og:image">
  
  <meta content="https://rzegocki.pl/blog/2015/04/19/installing-custom-linux-on-raspberry-pi-2/" name="og:url">
  <meta content='Installing custom Linux on Raspberry&nbsp;Pi&nbsp;2 - Igor \"ajgon\" Rzegocki' name="og:title">
  <meta content="Few days ago, I gave myself a present, which (at the very beginning) I was planning to powerup with OSMC and use it as HTPC. However, in a meantime I had to ..." name="og:description">

  <link type="text/css" rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://rzegocki.pl/blog/2015/04/19/installing-custom-linux-on-raspberry-pi-2/">
  <link rel="alternate" type="application/rss+xml" title='Igor \"ajgon\" Rzegocki' href="https://rzegocki.pl/feed.xml" />
</head>


  <body class="page-">
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
      <header class="mdl-layout__header mdl-layout__header--waterfall mdl-shadow--4dp">
  <div class="mdl-layout__header-row">
    <!-- Title -->
    <span class="mdl-layout-title"><a href="/">Igor \"ajgon\" Rzegocki</a></span>
    <!-- Add spacer, to align navigation to the right -->
    <div class="mdl-layout-spacer"></div>
    <!-- Navigation. We hide it in small screens. -->
    <nav class="icons-navigation mdl-navigation">
      <a id="download-cv" class="mdl-button mdl-js-button mdl-button--icon" href="/cv.pdf">
        <i class="material-icons">file_download</i>
      </a>
      <button id="connect-options" class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">more_vert</i>
      </button>

      <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect"
          for="connect-options">
          
            <li><a class="mdl-menu__item" href="https://github.com/ajgon" target="_blank">GitHub</a></li>
          
            <li><a class="mdl-menu__item" href="https://linkedin.com/in/ajgon" target="_blank">LinkedIN</a></li>
          
            <li><a class="mdl-menu__item" href="https://twitter.com/ajgon" target="_blank">Twitter</a></li>
          
            <li><a class="mdl-menu__item" href="https://keybase.io/ajgon" target="_blank">Keybase</a></li>
          
      </ul>
      <div for="download-cv" class="mdl-tooltip">Download CV</div>
      <div for="connect-options" class="mdl-tooltip">Connect</div>
    </nav>
  </div>
  <div class="mdl-layout__header-row mdl-layout__header-highlighted-row mdl-layout--large-screen-only">
    <nav class="waterfall-demo-header-nav mdl-navigation">
      
        
          
        
          
        
          
        
          
            <a href="/" class="mdl-navigation__link">About</a>
          
        
          
        
          
        
          
        
          
        
      
        
          
        
          
        
          
        
          
        
          
        
          
            <a href="/portfolio/" class="mdl-navigation__link">Portfolio</a>
          
        
          
        
          
        
      
        
          
        
          
        
          
        
          
        
          
            <a href="/open-source/" class="mdl-navigation__link">Open Source</a>
          
        
          
        
          
        
          
        
      
        
          
        
          
            <a href="/blog/" class="mdl-navigation__link is-active">Blog</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
    </nav>
  </div>
</header>
<div class="mdl-layout__drawer">
  <span class="mdl-layout-title"><a href="/">ajgon's personal</a></span>
  <nav class="mdl-navigation">
    
      
        
      
        
      
        
      
        
          <a href="/" class="mdl-navigation__link">About</a>
        
      
        
      
        
      
        
      
        
      
    
      
        
      
        
      
        
      
        
      
        
      
        
          <a href="/portfolio/" class="mdl-navigation__link">Portfolio</a>
        
      
        
      
        
      
    
      
        
      
        
      
        
      
        
      
        
          <a href="/open-source/" class="mdl-navigation__link">Open Source</a>
        
      
        
      
        
      
        
      
    
      
        
      
        
          <a href="/blog/" class="mdl-navigation__link is-active">Blog</a>
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
  </nav>
</div>


      <main class="mdl-layout__content">
        <div class="post-container full-post narrow mdl-grid">
    <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">
        <a href="/blog/2015/04/19/installing-custom-linux-on-raspberry-pi-2/">
            <div class="mdl-card__media mdl-color-text--grey-50" style="background-image: url(/assets/covers/installing-custom-linux-on-raspberry-pi-2.jpg">
                <h3>Installing custom Linux on Raspberry&nbsp;Pi&nbsp;2</h3>
            </div>
        </a>
                <div class="mdl-card__supporting-text meta mdl-color-text--grey-600">
            <div class="minilogo" style="background-image: url(/assets/avatars/ajgon.png);"></div>
            <div>
                <strong>ajgon</strong>
                <span>Apr 19, 2015</span>
            </div>
            <div class="mdl-layout-spacer"></div>
            <div>
                <button id="share_" class="mdl-button mdl-js-button mdl-button--icon">
                    <i class="material-icons">share</i>
                </button>

                <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect"
                    for="share_">
                        <li><a class="mdl-menu__item" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://rzegocki.pl/blog/2015/04/19/installing-custom-linux-on-raspberry-pi-2/&amp;title=" target="_blank" data-width="600" data-height="450">LinkedIN</a></li>
                        <li><a class="mdl-menu__item" href="https://twitter.com/share?url=https://rzegocki.pl/blog/2015/04/19/installing-custom-linux-on-raspberry-pi-2/&amp;text=" target="_blank" data-width="500" data-height="550">Twitter</a></li>
                        <li><a class="mdl-menu__item" href="https://www.facebook.com/sharer/sharer.php?u=https://rzegocki.pl/blog/2015/04/19/installing-custom-linux-on-raspberry-pi-2/&amp;display=popup" data-width="626" data-height="457" target="_blank">Facebook</a></li>
                </ul>
                <div class="mdl-tooltip" for="share_">Share</div>
            </div>
        </div>

        <div class="mdl-color-text--grey-700 mdl-card__supporting-text">
            <p>Few days ago, <a href="/assets/upload/rpi.jpg">I gave myself a present</a>, which (at the very beginning) I was planning to power
up with <a href="https://osmc.tv/">OSMC</a> and use it as HTPC. However, in a meantime I had to switch my apartment, and put
my worn ATOM server offline for couple of hours - necessity I didn’t like very much. This, and the fact that my server
got very noisy (I suspected power supply fan) convinced me to start looking for something new. And then I thought -
“Hey! I’ve got this awesome, little fella - I can attach Ethernet to it (or WiFi Dongle and LTE Hotspot from my phone)
to it and never worry about noise or being offline again!”. And I did, however installing custom Debian distribution,
wasn’t as trivial task as I expected…</p>

<!-- more -->

<h2 id="at-the-outset">At the outset</h2>

<p>In theory, when following this guide, you don’t need a monitor and keyboard to set up fully functional RPI2 Server.
However they are very helpful, when something doesn’t go as planned :-). This is especially truthful, when you are
trying to set up WiFi networking and you are using some non-standard chipset WiFi dongle.</p>

<h2 id="setting-up-vagrant">Setting up Vagrant</h2>

<p>I strongly recommend, to use some kind of virtual machine, for this setup. This will save you from polluting your
global system with packages, which you probably won’t need anymore. The easiest solution is to use
<a href="https://www.vagrantup.com/">Vagrant</a> with <a href="https://www.virtualbox.org/">VirtualBox</a> since they are both
multi-platform and easy to set up.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">Setting up vagrant</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">vagrant init ubuntu/trusty64
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">vagrant up
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">vagrant ssh</div></div></pre></div></figure>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">In vagrant</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">sudo -s <span class="c"># Change user to root</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nb">cd</span> /vagrant <span class="c"># Use a shared folder, all files created here will be visible outside of VM</span></div></div></pre></div></figure>

<p>If you do this, all code examples below (unless stated differently) will reflect to Vagrant root environment.</p>

<h2 id="preparing-sdcard-filesystem">Preparing SDCard Filesystem</h2>

<p>First of all, we need a properly partitioned image file, which later on we will copy to the SD card. Raspberry PI
doesn’t come with any kind of BIOS or low level boot-up system - everything is loaded directly from SD Card. Moreover
RPI expects a FAT partition with firmware files at the very beginning of the SD Disk. But first things first - let’s
install all the necessary packages:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">As root</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">apt-get update
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">apt-get install -y git binfmt-support qemu qemu-user-static debootstrap kpartx lvm2 dosfstools</div></div></pre></div></figure>

<p>Now we can setup the initial partitioning.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">As root</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>rpi.img <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">count</span><span class="o">=</span>768
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">losetup -f --show rpi.img <span class="c"># returns loop device used later, usually /dev/loop0</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">fdisk /dev/loop0</div></div></pre></div></figure>

<p>We need to create two partitions. As I mentioned, the first one needs to be FAT16 partition (type <code class="highlighter-rouge">e</code>), the second one
a Linux one (type <code class="highlighter-rouge">83</code>). So, to do this in fdisk invoke:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">As root</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">n <span class="c"># Create new partition</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">p <span class="c"># Set it as primary...</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">1 <span class="c"># ...and first</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="o">[</span>enter] <span class="c"># Start it from the beginning</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">+64M <span class="c"># And make it 64 Megabytes large (it is enough for the firmware)</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">t <span class="c"># Set partition type</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">e <span class="c"># to FAT16</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">n <span class="c"># Create new partition again</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">p <span class="c"># Set it as primary...</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">2 <span class="c"># ...and second</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="o">[</span>enter] <span class="c"># Start when old partition ends...</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="o">[</span>enter] <span class="c"># ...and use all available space</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line">w <span class="c"># Write all changes to the image</span></div></div></pre></div></figure>

<p>Next step is mounting those partitions as virtual devices and make filesystems on them:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">As root</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">losetup -d /dev/loop0
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">kpartx -va rpi.img <span class="c"># This will create two /dev/mapper devices, usually loop0p1 and loop0p2</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">mkfs.fat /dev/mapper/loop0p1
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">mkfs.ext4 /dev/mapper/loop0p2
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">mkdir boot root
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">mount /dev/mapper/loop0p1 boot
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">mount /dev/mapper/loop0p2 root</div></div></pre></div></figure>

<p>If you have problems with partitioning the file using <code class="highlighter-rouge">kpartx</code>, try to move it outside from <code class="highlighter-rouge">/vagrant</code> dir to
some place in virtual filesystem (homedir is fine), follow this guide, and then copy <code class="highlighter-rouge">.img</code> file back to <code class="highlighter-rouge">/vagrant</code>.</p>

<h2 id="installing-and-configuring-debian">Installing and configuring Debian</h2>

<p>After that, we have two directories: <code class="highlighter-rouge">boot</code> which will contain all RPI Firmware, and <code class="highlighter-rouge">root</code> which will contain our
desired distro (Debian). Now, it’s just a typical Debian bootstrapping. Since Raspberry Pi 2 finally
supports ARMv7, we can safely use Debian <code class="highlighter-rouge">armhf</code> architecture, and have all goodies like hardware floating points,
out of the box.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">As root</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">debootstrap --arch armhf --foreign wheezy root http://ftp.debian.org/debian/
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">cp /usr/bin/qemu-arm-static root/usr/bin/ <span class="c"># needed for syscall emulation</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nv">LANG</span><span class="o">=</span>C chroot root /debootstrap/debootstrap --second-stage
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">chroot root /bin/bash -c <span class="s2">"echo </span><span class="se">\"</span><span class="s2">root:raspberry</span><span class="se">\"</span><span class="s2"> | chpasswd"</span> <span class="c"># This will set root password to 'raspberry'</span></div></div></pre></div></figure>

<p>Next we need to set a minimal set of configuration files, to actually boot our disto.</p>

<p><em>Note: In code headers, I used absolute paths in relation to your RPI root directory, so if you want to set up
<code class="highlighter-rouge">/etc/fstab</code> you need to edit <code class="highlighter-rouge">root/etc/fstab</code> (if you followed this guide).</em></p>

<p>First is <code class="highlighter-rouge">/etc/fstab</code> which is used to mount initial partitions (boot and proc system).</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">Raspberry &#47;etc/fstab</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">proc            /proc           proc    defaults        0       0
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">/dev/mmcblk0p1  /boot           vfat    defaults        0       0</div></div></pre></div></figure>

<p>Next is hostname.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">Raspberry &#47;etc/hostname</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">raspberrypi2</div></div></pre></div></figure>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">Raspberry &#47;etc/hosts</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">127.0.0.1 raspberrypi2
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">::1 raspberrypi2</div></div></pre></div></figure>

<p>We also need to set up urls for Debian repositories, so we can download and manage system packages.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">Raspberry &#47;etc/apt/sources.list</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">deb http://ftp.debian.org/debian/ wheezy main contrib non-free</div></div></pre></div></figure>

<h2 id="installing-raspberrynbsppi-firmware">Installing Raspberry Pi firmware</h2>

<p>You can do it manually, but I strongly recommend to use <a href="https://github.com/Hexxeh/rpi-update">Hexxeh excellent tool</a>.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">As root</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">mkdir -p root/lib/modules
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">curl -L --output /usr/bin/rpi-update https://raw.githubusercontent.com/Hexxeh/rpi-update/master/rpi-update
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">chmod +x /usr/bin/rpi-update
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nv">SKIP_BACKUP</span><span class="o">=</span>1 <span class="nv">UPDATE_SELF</span><span class="o">=</span>0 <span class="nv">BOOT_PATH</span><span class="o">=</span>boot <span class="nv">ROOT_PATH</span><span class="o">=</span>root rpi-update
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nb">echo</span> <span class="s2">"dwc_otg.lpm_enable=0 console=ttyAMA0,115200 kgdboc=ttyAMA0,115200 console=tty1 root=/dev/mmcblk0p2 rootfstype=ext4 rw rootwait"</span> &gt; boot/cmdline.txt</div></div></pre></div></figure>

<p>And that’s it! At this point, if you have a monitor, you can flash your SD Card, plug it in to your Raspberry, and see
if your Debian boots up. If you also have a keyboard, you should be able to log in to it as well, and do the following
steps from there. Otherwise, keep using your <code class="highlighter-rouge">rpi.img</code>.</p>

<h2 id="chrooting">Chrooting</h2>

<p><em>You can skip this step, if you already booted up your system and configuring it from there.</em></p>

<p>Beforehand we need to mount <code class="highlighter-rouge">/dev</code> and <code class="highlighter-rouge">/proc</code> filesystems, to create a fully functional chrooted environment.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">As root</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">mount -t proc proc root/proc
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">mount --rbind /dev root/dev</div></div></pre></div></figure>

<p>Then, all is left is to simply type:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">As root</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">chroot root /bin/bash</div></div></pre></div></figure>

<h2 id="setting-up-necessary-configuration">Setting up necessary configuration</h2>

<p>At first, disable installation of recommended packages - for example, most of the time, we don’t want 3/4 of Xserver
while installing vim.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">As Raspberry root</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nb">echo</span> <span class="s1">'APT::Install-Recommends "0";'</span> &gt; /etc/apt/apt.conf.d/00norecommends</div></div></pre></div></figure>

<p>Next we need to setup a minimal dose of packages, which are necessary to use our distro — <code class="highlighter-rouge">locales</code> for
basic UTF8 language support, and <code class="highlighter-rouge">openssh-server</code> to allow us to actually sign in to the machine. I also
recommend to install <code class="highlighter-rouge">ntp</code> to avoid any timestamp-based confusions.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">As Raspberry root</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">apt-get update
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nv">LANG</span><span class="o">=</span>C apt-get install locales
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nb">echo</span> <span class="s2">"en_US.UTF-8 UTF-8"</span> &gt;&gt; /etc/locale.gen
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">locale-gen
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">apt-get install openssh-server openssh-blacklist openssh-blacklist-extra ntp</div></div></pre></div></figure>

<p>If you plan, to configure your system with Ansible or some other auto-tool, it’s also a good idea to install
sudo, python and aptitude.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">As Raspberry root</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">apt-get install sudo python aptitude</div></div></pre></div></figure>

<h2 id="configuring-network">Configuring network</h2>

<p>Easiest case scenario is Ethernet with DHCP. Keep in mind, that if you don’t plan to use ethernet at all (only WiFi),
you should skip this step, as it will slow down boot up of Pi significantly (the machine will try to establish ethernet
connection for over 60s). Otherwise, all you need to do is add following lines to <code class="highlighter-rouge">/etc/network/interfaces</code>:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">Raspberry &#47;etc/network/interfaces</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">auto lo
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">iface lo inet loopback
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">auto eth0
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">iface eth0 inet dhcp
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">dns-nameservers 208.67.222.222 208.67.220.220</div></div></pre></div></figure>

<p>It’s a good idea to force nameservers (i.e. to OpenDNS as in example above) - many providers, are setting default DNS
servers to Google DNS, <a href="https://developers.google.com/speed/public-dns/faq#privacy">which is not the best choice</a>.</p>

<p>To make <code class="highlighter-rouge">dns-nameservers</code> directive actually work, you would need a <code class="highlighter-rouge">resolvconf</code> package.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">Raspbery root</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">apt-get install resolvconf</div></div></pre></div></figure>

<p>And that’s it. It’s getting more complicated if you want to configure a WiFi network as well.</p>

<h3 id="configuring-wi-fi">Configuring Wi-Fi</h3>

<p>In my case, I used a <a href="http://www.element14.com/community/docs/DOC-48541?ICID=rpiaccsy-access-products#">WiPi</a> WiFi
adapter. If you have a different one, you need to use a <a href="https://packages.debian.org/source/wheezy/firmware-nonfree">proper firmware</a>
instead of the one which I used.</p>

<p>At first, you need to install all necessary dependencies…</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">As Raspberry root</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">apt-get install firmware-ralink <span class="c"># Use your firmware driver here</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">apt-get install wireless-tools wpasupplicant</div></div></pre></div></figure>

<p>… and configure a network interface:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">Raspberry &#47;etc/network/interfaces</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c"># Add those lines at the end of the file</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">allow-hotplug wlan0
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">auto wlan0
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">iface wlan0 inet dhcp
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">dns-nameservers 208.67.222.222 208.67.220.220
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">wpa-conf /etc/wpa_supplicant/wpa_supplicant.conf</div></div></pre></div></figure>

<p>Last thing is configuring all networks you wish your Raspberry to connect. This is very convinient, if you plan to move
your machine between home, work etc. - you can configure all trusted networks credentials, and later - just power on
and be online.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">Raspberry &#47;etc/wpa_supplicant/wpa_supplicant.conf</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nv">ctrl_interface</span><span class="o">=</span><span class="nv">DIR</span><span class="o">=</span>/var/run/wpa_supplicant <span class="nv">GROUP</span><span class="o">=</span>netdev
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nv">update_config</span><span class="o">=</span>1
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nv">network</span><span class="o">=&#x7b;</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nv">ssid</span><span class="o">=</span><span class="s2">"MyHomeNetwork"</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nv">psk</span><span class="o">=</span><span class="s2">"MyHomePassword"</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nv">id_str</span><span class="o">=</span><span class="s2">"home"</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="o">&#x7d;</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nv">network</span><span class="o">=&#x7b;</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nv">ssid</span><span class="o">=</span><span class="s2">"MyWorkNetwork"</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nv">psk</span><span class="o">=</span><span class="s2">"MyWorkPassword"</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nv">id_str</span><span class="o">=</span><span class="s2">"work"</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="o">&#x7d;</span></div></div></pre></div></figure>

<h2 id="flashing">Flashing</h2>

<p>It’s good idea, to do the cleanup after finishing the image.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">As Raspberry root</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">apt-get autoremove --purge
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">apt-get clean</div></div></pre></div></figure>

<p>Now you can exit the chroot (and VM if you used it), and flash your SDCard. In OSX you can do this by:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">OSX Shell</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">diskutil list <span class="c"># Check for you SDCard disk number</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">diskutil umountDisk /dev/diskX <span class="c"># Where X is a disc number</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">sudo dd <span class="nv">bs</span><span class="o">=</span>1m <span class="k">if</span><span class="o">=</span>rpi.img <span class="nv">of</span><span class="o">=</span>/dev/rdiskX
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">diskutil eject /dev/diskX</div></div></pre></div></figure>

<p>Notice, that for <code class="highlighter-rouge">dd</code> I’m using <code class="highlighter-rouge">/dev/rdiskX</code> instead of the <code class="highlighter-rouge">/dev/diskX</code>. It’s because how OSX handles disk devices.
<a href="http://superuser.com/questions/631592/why-is-dev-rdisk-about-20-times-faster-than-dev-disk-in-mac-os-x">You can read more here</a>
if you are intereseted.</p>

<p>In Linux it’s as simple as typing:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">Linux</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">sudo dd <span class="k">if</span><span class="o">=</span>rpi.img <span class="nv">of</span><span class="o">=</span>/dev/sdX <span class="c"># Where X is a disk letter</span></div></div></pre></div></figure>

<h2 id="finishing-up">Finishing up</h2>

<p>Put your card into your Raspberry and boot it up! If everything goes well, you should be able to SSH to it.
If you haven’t use monitor and keyboard, you might end not knowing which IP address SSH to. The easiest solution for
this problem is use <code class="highlighter-rouge">nmap</code> to detect all open hosts in your subnet, then check which one responds to <code class="highlighter-rouge">root</code> user
with <code class="highlighter-rouge">raspberry</code> password.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">In terminal</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">nmap -p22 -oG - --open 192.168.0.0/24 | grep Host | awk <span class="s1">'&#x7b;print $2&#x7d;'</span> | sort | uniq</div></div></pre></div></figure>

<p>Don’t forget to change your root password (or disable root login at all) and to secure your system after you sign in!
The next thing, you might notice is, that your Linux partition is pretty small (768MB). This is due to fact, that
the original image was created as small as possible, to reduce flashing time. Thankfully, you can expand it pretty
easily.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">As raspberry root</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">fdisk /dev/mmcblk0
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c"># In fdisk</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">d <span class="c"># Delete partition...</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">2 <span class="c"># ... the linux partition (don't worry, you won't lose your data)</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">n <span class="c"># Create ...</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">p <span class="c"># ... primary partition ...</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">2 <span class="c"># number 2</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="o">[</span>enter] <span class="c"># Start from the beginning of the free space (as the previous did) ...</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="o">[</span>enter] <span class="c"># ... but end up filling all available space</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">w <span class="c"># write changes</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c"># In shell</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line">reboot <span class="c"># to make new partition visible for the system</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line">resize2fs /dev/mmcblk0p2 <span class="c"># Resize filesystem to fill up whole partition space</span></div></div></pre></div></figure>

<p>Happy hacking!</p>

<h2 id="may-04-update-debian-jessie">[May 04 update] Debian Jessie</h2>

<p>Few days ago, <a href="https://www.debian.org/News/2015/20150426">Debian Jessie came out</a>. I checked this guide against it, and
everything should work out of the box. However, few slight alterations are necessary:</p>

<ul>
  <li>change <code class="highlighter-rouge">wheezy</code> to <code class="highlighter-rouge">jessie</code> in debootstrap phase and in <code class="highlighter-rouge">/etc/apt/sources.list</code> file</li>
  <li>the new <code class="highlighter-rouge">/etc/network/interfaces.d</code> format was introduced, so instead putting all of your newtork conf in one file,
you can split it to separate files and them put in this directory (i.e. <code class="highlighter-rouge">/etc/network/interfaces.d/lo</code>,
<code class="highlighter-rouge">etc/network/interfaces.d/wifi</code> etc.).</li>
  <li>you might also have problems with <code class="highlighter-rouge">root</code> login via SSH, if so, set <code class="highlighter-rouge">PermitRootLogin yes</code>
in <code class="highlighter-rouge">/etc/ssh/sshd_config</code> (but don’t forget, to set it back to <code class="highlighter-rouge">no</code> when you finish configuration!).</li>
</ul>

        </div>

        <div id="disqus_thread" class="comments-disqus"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES * * */
            var disqus_shortname = 'ajgon';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </div>
</div>


        <footer class="mdl-mega-footer">
  <div class="mdl-mega-footer__top-section mdl-grid">
    <div class="mdl-cell mdl-cell--4-col">
      <h5 class="headline">Open Source</h5>
      <ul class="mdl-mega-footer--link-list mdl-mega-footer--left-align" id="recent-tweets">
        <li><a href="http://opsworks-ruby.rzegocki.pl/" target="_blank">opsworks_ruby</a></li>
        <li><a href="https://github.com/ajgon/self-hosted-mailserver" target="_blank">self-hosted-mailserver</a></li>
        <li><a href="https://github.com/ajgon/lint-pack" target="_blank">LintPack</a></li>
        <li><a href="https://github.com/ajgon/chef-imagetragick" target="_blank">chef-imagetragick</a></li>
        <li><a href="https://github.com/ajgon/jquery-timer" target="_blank">jquery.timer</a></li>
      </ul>
    </div>
    <div class="mdl-cell mdl-cell--4-col">
      <h5 class="headline">Connect</h5>
      
        <a class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect" href="https://github.com/ajgon" id="connect_Q" target="_blank">
          <i class="material-icons socicon">Q</i>
        </a>
        <div for="connect_Q" class="mdl-tooltip">GitHub</div>
      
        <a class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect" href="https://linkedin.com/in/ajgon" id="connect_j" target="_blank">
          <i class="material-icons socicon">j</i>
        </a>
        <div for="connect_j" class="mdl-tooltip">LinkedIN</div>
      
        <a class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect" href="https://twitter.com/ajgon" id="connect_a" target="_blank">
          <i class="material-icons socicon">a</i>
        </a>
        <div for="connect_a" class="mdl-tooltip">Twitter</div>
      
        <a class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect" href="https://keybase.io/ajgon" id="connect_vpn_key" target="_blank">
          <i class="material-icons">vpn_key</i>
        </a>
        <div for="connect_vpn_key" class="mdl-tooltip">Keybase</div>
      
    </div>
    <div class="mdl-cell mdl-cell--4-col">
      <h5 class="headline">Contact</h5>
      <ul class="mdl-mega-footer--link-list">
        <li>
          Mail:
          <script><!--
            document.write('<a href="mai'),document.write("lto"),document.write(":&#105;&#103;&#111;&#114;"),document.write("@"),document.write('&#114;&#122;&#101;&#103;&#111;&#99;&#107;&#105;&#46;&#112;&#108;">'),document.write("&#105;&#103;&#111;&#114;"),document.write("@"),document.write("&#114;&#122;&#101;&#103;&#111;&#99;&#107;&#105;&#46;&#112;&#108;</a>");
          // --></script><noscript>:&#105;&#103;&#111;&#114; at
&#114;&#122;&#101;&#103;&#111;&#99;&#107;&#105; dot &#112;&#108;</noscript>
        </li>
        <li>
          Skype: <a href="skype:igor.rzegocki">igor.rzegocki</a>
        </li>
      </ul>
    </div>
  </div>
  <div class="mdl-mega-footer__bottom-section">
    Copyright &copy; 2015-2017 - <a href="/avatar.html">Igor Rzegocki</a> - Powered by <a href="http://octopress.org/" target="_blank">Octopress</a>.
    Previous version of the site, available <a href="/v3">here</a>.
  </div>
</footer>

      </main>
    </div>

    <script type="text/javascript" src="/assets/main.js"></script>

<script>
  window['GoogleAnalyticsObject'] = 'ga';
  ga('create', 'UA-65616575-1', 'auto');
  ga('send', 'pageview');
</script>

  </body>

</html>
