<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Setting encrypted backup Email server - Igor \"ajgon\" Rzegocki</title>
  <meta name="description" content="There is a popular Internet saying that people are divided into two groups -those who make backups, and those who will. I strongly believe into that,that’s w...">

  
  <meta content="/assets/covers/setting-encrypted-backup-email-server-128073399740e6f4dde300ee8dada813c9028df3bdb3120aa5db51d9354ad3f1.jpg" name="og:image">
  
  <meta content="http://rzegocki.pl/blog/2013/04/14/setting-encrypted-backup-email-server/" name="og:url">
  <meta content='Setting encrypted backup Email server - Igor \"ajgon\" Rzegocki' name="og:title">
  <meta content="There is a popular Internet saying that people are divided into two groups -those who make backups, and those who will. I strongly believe into that,that’s w..." name="og:description">


  <link type="text/css" rel="stylesheet" href="/assets/main-9d80b6fcd2dbad4f997bd77be012cfe80f28762c26dc08586c16244e2374340e.css">
  <link rel="canonical" href="http://rzegocki.pl/blog/2013/04/14/setting-encrypted-backup-email-server/">
  <link rel="alternate" type="application/rss+xml" title='Igor \"ajgon\" Rzegocki' href="http://rzegocki.pl/feed.xml" />
</head>


  <body>
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
      <header class="mdl-layout__header mdl-layout__header--waterfall mdl-shadow--4dp">
  <div class="mdl-layout__header-row">
    <!-- Title -->
    <span class="mdl-layout-title"><a href="/">Igor \"ajgon\" Rzegocki</a></span>
    <!-- Add spacer, to align navigation to the right -->
    <div class="mdl-layout-spacer"></div>
    <!-- Navigation. We hide it in small screens. -->
    <nav class="icons-navigation mdl-navigation">
      <a id="download-cv" class="mdl-button mdl-js-button mdl-button--icon" href="/cv.pdf">
        <i class="material-icons">file_download</i>
      </a>
      <button id="connect-options" class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">more_vert</i>
      </button>

      <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect"
          for="connect-options">
          
            <li><a class="mdl-menu__item" href="https://github.com/ajgon" target="_blank">GitHub</a></li>
          
            <li><a class="mdl-menu__item" href="https://linkedin.com/in/ajgon" target="_blank">LinkedIN</a></li>
          
            <li><a class="mdl-menu__item" href="https://twitter.com/ajgon" target="_blank">Twitter</a></li>
          
            <li><a class="mdl-menu__item" href="/public-key.txt" target="_blank">GPG Key</a></li>
          
      </ul>
      <div for="download-cv" class="mdl-tooltip">Download CV</div>
      <div for="connect-options" class="mdl-tooltip">Connect</div>
    </nav>
  </div>
  <div class="mdl-layout__header-row mdl-layout__header-highlighted-row mdl-layout--large-screen-only">
    <nav class="waterfall-demo-header-nav mdl-navigation">
      
        
          
        
          
        
          
        
          
            <a href="/" class="mdl-navigation__link">About</a>
          
        
          
        
          
        
          
        
      
        
          
        
          
        
          
        
          
        
          
        
          
            <a href="/portfolio/" class="mdl-navigation__link">Portfolio</a>
          
        
          
        
      
        
          
        
          
        
          
        
          
        
          
            <a href="/open-source/" class="mdl-navigation__link">Open Source</a>
          
        
          
        
          
        
      
        
          
        
          
            <a href="/blog/" class="mdl-navigation__link is-active">Blog</a>
          
        
          
        
          
        
          
        
          
        
          
        
      
    </nav>
  </div>
</header>
<div class="mdl-layout__drawer">
  <span class="mdl-layout-title"><a href="/">ajgon's personal</a></span>
  <nav class="mdl-navigation">
    
      
        
      
        
      
        
      
        
          <a href="/" class="mdl-navigation__link">About</a>
        
      
        
      
        
      
        
      
    
      
        
      
        
      
        
      
        
      
        
      
        
          <a href="/portfolio/" class="mdl-navigation__link">Portfolio</a>
        
      
        
      
    
      
        
      
        
      
        
      
        
      
        
          <a href="/open-source/" class="mdl-navigation__link">Open Source</a>
        
      
        
      
        
      
    
      
        
      
        
          <a href="/blog/" class="mdl-navigation__link is-active">Blog</a>
        
      
        
      
        
      
        
      
        
      
        
      
    
  </nav>
</div>


      <main class="mdl-layout__content">
        <div class="post-container full-post narrow mdl-grid">
    <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">
        <a href="/blog/2013/04/14/setting-encrypted-backup-email-server/">
            <div class="mdl-card__media mdl-color-text--grey-50" style="background-image: url(/assets/covers/setting-encrypted-backup-email-server-128073399740e6f4dde300ee8dada813c9028df3bdb3120aa5db51d9354ad3f1.jpg">
                <h3>Setting encrypted backup Email server</h3>
            </div>
        </a>
                <div class="mdl-card__supporting-text meta mdl-color-text--grey-600">
            <div class="minilogo" style="background-image: url(/assets/avatars/ajgon-04f8c4022f2e292c90f22f4682f2f27b8f6678bc7bab4d6e306885d2386c42c7.png);"></div>
            <div>
                <strong>ajgon</strong>
                <span>Apr 14, 2013</span>
            </div>
            <div class="mdl-layout-spacer"></div>
            <div>
                <button id="share_" class="mdl-button mdl-js-button mdl-button--icon">
                    <i class="material-icons">share</i>
                </button>

                <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect"
                    for="share_">
                        <li><a class="mdl-menu__item" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http://rzegocki.pl/blog/2013/04/14/setting-encrypted-backup-email-server/&amp;title=" target="_blank" data-width="600" data-height="450">LinkedIN</a></li>
                        <li><a class="mdl-menu__item" href="https://twitter.com/share?url=http://rzegocki.pl/blog/2013/04/14/setting-encrypted-backup-email-server/&amp;text=" target="_blank" data-width="500" data-height="550">Twitter</a></li>
                        <li><a class="mdl-menu__item" href="https://www.facebook.com/sharer/sharer.php?u=http://rzegocki.pl/blog/2013/04/14/setting-encrypted-backup-email-server/&amp;display=popup" data-width="626" data-height="457" target="_blank">Facebook</a></li>
                </ul>
                <div class="mdl-tooltip" for="share_">Share</div>
            </div>
        </div>

        <div class="mdl-color-text--grey-700 mdl-card__supporting-text">
            <p>There is a popular Internet saying that people are divided into two groups -
those who make backups, and those who will. I strongly believe into that,
that’s why despite that I trust my mailserver setup completely, I still want to
keep them in some other safe place. Probably somewhere, where somebody else
takes care of everything :) That’s why I chose
<a href="http://mail.zoho.com/">ZOHO MAIL</a> as my backup server.</p>

<!--more-->

<p>Mostly for three reasons:</p>

<ul>
  <li>They have IMAP</li>
  <li>They have enough space for free</li>
  <li>They also provide a nice webmail</li>
</ul>

<p>So my next task was to configure postfix in a way, that it will deliver all the
messages as it does currently, but also forward them to zoho.com. Of course I
wasn’t THAT crazy, to send my private emails over the Internet as they are, so
I also needed some kind of encryption before that. It appeared that somebody
had the same problem, and there is a tool for that called
<a href="http://code.google.com/p/gpg-mailgate/">gpg-mailgate</a>. Unfortunately it’s a
very unfinished application, and lots of things doesn’t work (multipart
messages support, attachmenets encryption, extra email encryption and so on),
so I needed to do
<a href="https://github.com/ajgon/gpg-mailgate">a little bit of extra hacking</a>. And I
strongly recommend you, to use my version if you thinking about encrypting your
email out of the box. Ok, that’s for the beginning - let’s do some
configuration!</p>

<h2 id="setting-gpg">Setting gpg</h2>

<p>First thing is to install and configure a gpg account. I strongly recommend to
not to use your gpg keys (if you already have some), but create new, clean key.
Also, we need a new user in the file system for postfix to handle key support.
Lastly, gpg-mailgate comes with a Python library, which also needs to be
installed.</p>

<p>Install GPG:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">As root</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">apt-get install gpg</div></div></pre></div></figure>

<p>Create a gpg user and give him the key (don’t forget to disable the password,
and set trust to ultimate - otherwise tour scripts will stop to ask about
confirmation - and eventually fail):</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">As root</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">useradd -s /bin/false -d /var/gpg -M gpgmap
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">mkdir -p /var/gpg/.gnupg
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">chown -R gpgmap /var/gpg
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">chmod <span class="m">700</span> /var/gpg/.gnupg
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">sudo -u gpgmap /usr/bin/gpg --gen-key --homedir<span class="o">=</span>/var/gpg/.gnupg
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">sudo -u gpgmap gpg --edit-key your@key.email.com trust quit</div></div></pre></div></figure>

<h2 id="setting-gpg-mailgate">Setting gpg-mailgate</h2>

<p>Install GnuPG Python library, and gpg-mailgate itself:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">As root</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nb">cd</span> /root
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">git clone https://github.com/ajgon/gpg-mailgate.git
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nb">cd </span>gpg-mailgate
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">cp -R GnuPG /usr/lib/python2.6
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">cp gpg-mailgate.py /usr/local/bin/gpg-mailgate.py
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">cp gpg-mailgate.conf.sample /etc/gpg-mailgate.conf</div></div></pre></div></figure>

<p>Config file is pretty explanatory - what you have to change is “domains”
parameter (put only domains, which you want to receive encrypted messages),
keyhome (set to <code class="highlighter-rouge">/var/gpg/.gnupg</code>) and keymap (map all the emails which should
receive encrypted content there - follow the hint in file). So all in all your
config file should look similar to this:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">/etc/gpg-mailgate.conf</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">[default]</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="na">add_header</span> <span class="o">=</span> <span class="s">yes</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="na">domains</span> <span class="o">=</span> <span class="s">zoho.com</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">[gpg]</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="na">keyhome</span> <span class="o">=</span> <span class="s">/var/gpg/.gnupg</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">[logging]</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="na">file</span> <span class="o">=</span> <span class="s">/tmp/gpg-mailgate.log</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">[relay]</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="na">host</span> <span class="o">=</span> <span class="s">127.0.0.1</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="na">port</span> <span class="o">=</span> <span class="s">10028</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">[keymap]</span>
</div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="na">email.which.will.receive.encrypted.content@zoho.com</span> <span class="o">=</span> <span class="s">123456789ABCDEF</span></div></div></pre></div></figure>

<h2 id="setting-postfix">Setting postfix</h2>

<p>The last thing is postfix configuration which is (surprisingly) really easy,
just activate content filter in <code class="highlighter-rouge">main.cf</code> and add relay to <code class="highlighter-rouge">master.cf</code>. One
last thing is to add X-GPG-* headers to tell the script, which extra email
addresses we want to deliver messages encrypted. Normally gpg-mailgate encrypts
only messages to addresses that are configured in gpg-mailgate.conf file and
available in To/Cc/Bcc headers of original message. Unfortunatelly, we are
using a totally different zoho.com email intended only for backups - it will
never appear in original message headers, because it’s not the recipient. To
make it appear - simply add <code class="highlighter-rouge">X-GPG-Encrypt-Cc</code> header to your message. So, the
configuration will present as follows:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">/etc/postfix/main.cf</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c"># gpg</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nv">header_checks</span> <span class="o">=</span> regexp:/etc/postfix/header_checks
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nv">content_filter</span> <span class="o">=</span> gpg-mailgate</div></div></pre></div></figure>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">/etc/postfix/header_checks</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">/^From: .*/ PREPEND X-GPG-Encrypt-Cc: email.which.will.receive.encrypted.content@zoho.com</div></div></pre></div></figure>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">/etc/postfix/master.cf</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c"># gpg-mailgate</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">gpg-mailgate    unix    -       n       n       -       -       pipe
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="nv">flags</span><span class="o">=</span> <span class="nv">user</span><span class="o">=</span>gpgmap <span class="nv">argv</span><span class="o">=</span>/usr/local/bin/gpg-mailgate.py
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">127.0.0.1:10028 inet    n       -       n       -       <span class="m">10</span>      smtpd
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">        -o <span class="nv">content_filter</span><span class="o">=</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">        -o <span class="nv">receive_override_options</span><span class="o">=</span>no_unknown_recipient_checks,no_header_body_checks
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">        -o <span class="nv">smtpd_helo_restrictions</span><span class="o">=</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">        -o <span class="nv">smtpd_client_restrictions</span><span class="o">=</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">        -o <span class="nv">smtpd_sender_restrictions</span><span class="o">=</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">        -o <span class="nv">smtpd_recipient_restrictions</span><span class="o">=</span>permit_mynetworks,reject
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line">        -o <span class="nv">mynetworks</span><span class="o">=</span>127.0.0.0/8
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line">        -o <span class="nv">smtpd_authorized_xforward_hosts</span><span class="o">=</span>127.0.0.0/8</div></div></pre></div></figure>

<p>Don’t forget to create <code class="highlighter-rouge">header_checks.db</code> and restart postfix.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">As root</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">postmap header_checks
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">/etc/init.d/postfix restart</div></div></pre></div></figure>

<p>And that’s pretty much everything. Send yourself an email, and enjoy your new,
shiny and secure backup :)</p>

<h3 id="sources">Sources</h3>

<ul>
  <li><a href="http://ultramegaman.wordpress.com/tag/gpg-mailgate/">http://ultramegaman.wordpress.com/tag/gpg-mailgate/</a></li>
</ul>

        </div>

        <div id="disqus_thread" class="comments-disqus"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES * * */
            var disqus_shortname = 'ajgon';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </div>
</div>


        <footer class="mdl-mega-footer">
  <div class="mdl-mega-footer__top-section mdl-grid">
    <div class="mdl-cell mdl-cell--4-col">
      <h5 class="headline">Recent Tweets</h5>
      <ul class="mdl-mega-footer--link-list mdl-mega-footer--left-align" id="recent-tweets">
        Loading tweets...
      </ul>
    </div>
    <div class="mdl-cell mdl-cell--4-col">
      <h5 class="headline">Connect</h5>
      
        <a class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect" href="https://github.com/ajgon" id="connect_Q" target="_blank">
          <i class="material-icons socicon">Q</i>
        </a>
        <div for="connect_Q" class="mdl-tooltip">GitHub</div>
      
        <a class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect" href="https://linkedin.com/in/ajgon" id="connect_j" target="_blank">
          <i class="material-icons socicon">j</i>
        </a>
        <div for="connect_j" class="mdl-tooltip">LinkedIN</div>
      
        <a class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect" href="https://twitter.com/ajgon" id="connect_a" target="_blank">
          <i class="material-icons socicon">a</i>
        </a>
        <div for="connect_a" class="mdl-tooltip">Twitter</div>
      
        <a class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect" href="/public-key.txt" id="connect_vpn_key" target="_blank">
          <i class="material-icons">vpn_key</i>
        </a>
        <div for="connect_vpn_key" class="mdl-tooltip">GPG Key</div>
      
    </div>
    <div class="mdl-cell mdl-cell--4-col">
      <h5 class="headline">Contact</h5>
      <ul class="mdl-mega-footer--link-list">
        <li>
          Mail:
          <script><!--
            document.write('<a href="mai'),document.write("lto"),document.write(":&#105;&#103;&#111;&#114;"),document.write("@"),document.write('&#114;&#122;&#101;&#103;&#111;&#99;&#107;&#105;&#46;&#112;&#108;">'),document.write("&#105;&#103;&#111;&#114;"),document.write("@"),document.write("&#114;&#122;&#101;&#103;&#111;&#99;&#107;&#105;&#46;&#112;&#108;</a>");
          // --></script><noscript>:&#105;&#103;&#111;&#114; at
&#114;&#122;&#101;&#103;&#111;&#99;&#107;&#105; dot &#112;&#108;</noscript>
        </li>
        <li>
          Skype: <a href="skype:igor.rzegocki">igor.rzegocki</a>
        </li>
      </ul>
    </div>
  </div>
  <div class="mdl-mega-footer__bottom-section">
    Copyright © 2015 - <a href="/avatar.html">Igor Rzegocki</a> - Powered by <a href="http://octopress.org/" target="_blank">Octopress</a>.
    Previous version of the site, available <a href="/v3">here</a>.
  </div>
</footer>

      </main>
    </div>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-65616575-1', 'auto');
  ga('send', 'pageview');
</script>

<script type="text/javascript" src="/assets/main-3feec1df9e9d8a898456aaad7cf6f66e616f4dd2acdda0a1e69d423298ff0ef2.js"></script>

  </body>

</html>
