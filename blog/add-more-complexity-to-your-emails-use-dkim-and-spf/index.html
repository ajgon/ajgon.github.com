<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Add more complexity to your Emails - use DKIM and SPF - Igor \"ajgon\" Rzegocki</title>
  <meta name="description" content="The next thing my paranoid me couldn’t stand of is that my emails can be easilyspoofed. Yeah, I know I’m not a very famous person, so probability of suchthin...">

  
  <meta content="/assets/covers/add-more-complexity-to-your-emails-use-dkim-and-spf-31bb7e366e3aee88ae0e9d629dd89ff620e88e93d47c8f62df6b90beee94a1ad.jpg" name="og:image">
  
  <meta content="https://rzegocki.pl/blog/add-more-complexity-to-your-emails-use-dkim-and-spf/" name="og:url">
  <meta content='Add more complexity to your Emails - use DKIM and SPF - Igor \"ajgon\" Rzegocki' name="og:title">
  <meta content="The next thing my paranoid me couldn’t stand of is that my emails can be easilyspoofed. Yeah, I know I’m not a very famous person, so probability of suchthin..." name="og:description">

  <link type="text/css" rel="stylesheet" href="/assets/main-33880d74182900bcdaeeda99522e5543f32fbe9cdcc2361196962ace3ea7689b.css">
  <link rel="canonical" href="https://rzegocki.pl/blog/add-more-complexity-to-your-emails-use-dkim-and-spf/">
  <link rel="alternate" type="application/rss+xml" title='Igor \"ajgon\" Rzegocki' href="https://rzegocki.pl/feed.xml" />
</head>


  <body class="page-bg">
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
      <header class="mdl-layout__header mdl-layout__header--waterfall mdl-shadow--4dp">
  <div class="mdl-layout__header-row">
    <!-- Title -->
    <span class="mdl-layout-title"><a href="/">Igor \"ajgon\" Rzegocki</a></span>
    <!-- Add spacer, to align navigation to the right -->
    <div class="mdl-layout-spacer"></div>
    <!-- Navigation. We hide it in small screens. -->
    <nav class="icons-navigation mdl-navigation">
      <a id="download-cv" class="mdl-button mdl-js-button mdl-button--icon" href="/cv.pdf">
        <i class="material-icons">file_download</i>
      </a>
      <button id="connect-options" class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">more_vert</i>
      </button>

      <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect"
          for="connect-options">
          
            <li><a class="mdl-menu__item" href="https://github.com/ajgon" target="_blank">GitHub</a></li>
          
            <li><a class="mdl-menu__item" href="https://linkedin.com/in/ajgon" target="_blank">LinkedIN</a></li>
          
            <li><a class="mdl-menu__item" href="https://twitter.com/ajgon" target="_blank">Twitter</a></li>
          
            <li><a class="mdl-menu__item" href="https://keybase.io/ajgon" target="_blank">Keybase</a></li>
          
      </ul>
      <div for="download-cv" class="mdl-tooltip">Download CV</div>
      <div for="connect-options" class="mdl-tooltip">Connect</div>
    </nav>
  </div>
  <div class="mdl-layout__header-row mdl-layout__header-highlighted-row mdl-layout--large-screen-only">
    <nav class="waterfall-demo-header-nav mdl-navigation">
      
        
          
        
          
        
          
        
          
            <a href="/" class="mdl-navigation__link">About</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
        
          
        
          
        
          
        
          
        
          
        
          
            <a href="/portfolio/" class="mdl-navigation__link">Portfolio</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
        
          
        
          
        
          
        
          
        
          
            <a href="/open-source/" class="mdl-navigation__link">Open Source</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
        
          
        
          
            <a href="/blog/" class="mdl-navigation__link is-active">Blog</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
    </nav>
  </div>
</header>
<div class="mdl-layout__drawer">
  <span class="mdl-layout-title"><a href="/">ajgon's personal</a></span>
  <nav class="mdl-navigation">
    
      
        
      
        
      
        
      
        
          <a href="/" class="mdl-navigation__link">About</a>
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
      
        
      
        
      
        
      
        
      
        
      
        
          <a href="/portfolio/" class="mdl-navigation__link">Portfolio</a>
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
      
        
      
        
      
        
      
        
      
        
          <a href="/open-source/" class="mdl-navigation__link">Open Source</a>
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
      
        
      
        
          <a href="/blog/" class="mdl-navigation__link is-active">Blog</a>
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
  </nav>
</div>


      <main class="mdl-layout__content">
        <div class="post-container full-post narrow mdl-grid">
    <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">
        <a href="/blog/add-more-complexity-to-your-emails-use-dkim-and-spf/">
            <div class="mdl-card__media mdl-color-text--grey-50" style="background-image: url(/assets/covers/add-more-complexity-to-your-emails-use-dkim-and-spf-31bb7e366e3aee88ae0e9d629dd89ff620e88e93d47c8f62df6b90beee94a1ad.jpg">
                <h3>Add more complexity to your Emails - use DKIM and SPF</h3>
            </div>
        </a>
                <div class="mdl-card__supporting-text meta mdl-color-text--grey-600">
            <div class="minilogo" style="background-image: url(/assets/avatars/ajgon-04f8c4022f2e292c90f22f4682f2f27b8f6678bc7bab4d6e306885d2386c42c7.png);"></div>
            <div>
                <strong>ajgon</strong>
                <span>Oct 27, 2012</span>
            </div>
            <div class="mdl-layout-spacer"></div>
            <div>
                <button id="share_" class="mdl-button mdl-js-button mdl-button--icon">
                    <i class="material-icons">share</i>
                </button>

                <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect"
                    for="share_">
                        <li><a class="mdl-menu__item" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://rzegocki.pl/blog/add-more-complexity-to-your-emails-use-dkim-and-spf/&amp;title=" target="_blank" data-width="600" data-height="450">LinkedIN</a></li>
                        <li><a class="mdl-menu__item" href="https://twitter.com/share?url=https://rzegocki.pl/blog/add-more-complexity-to-your-emails-use-dkim-and-spf/&amp;text=" target="_blank" data-width="500" data-height="550">Twitter</a></li>
                        <li><a class="mdl-menu__item" href="https://www.facebook.com/sharer/sharer.php?u=https://rzegocki.pl/blog/add-more-complexity-to-your-emails-use-dkim-and-spf/&amp;display=popup" data-width="626" data-height="457" target="_blank">Facebook</a></li>
                </ul>
                <div class="mdl-tooltip" for="share_">Share</div>
            </div>
        </div>

        <div class="mdl-color-text--grey-700 mdl-card__supporting-text">
            <p>The next thing my paranoid me couldn’t stand of is that my emails can be easily
spoofed. Yeah, I know I’m not a very famous person, so probability of such
thing happening is similar to zero, but hey - tell this to my Paranoid me. :)
I also sign every mail I could (they can be easily verified using
<a href="/public-key.txt">my public key</a>), but still - DKIM seems to be a fine
solution. And besides, I love to play with new things. So after many
experiments with <a href="http://sourceforge.net/projects/dkim-milter/">dkim-milter</a>,
<a href="http://sourceforge.net/projects/dkimproxy/">DKIMProxy</a> and
<a href="http://www.opendkim.org/">opendkim</a> I finally decided to use the last one.
Mostly because it’s easiest to configure and is still maintained.</p>

<!--more-->

<h2 id="installing-and-configuring-opendkim">Installing and configuring opendkim</h2>

<p>You will be suprised how simple it is. :) Firstly you need to install a proper
debian packages:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">As root</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">apt-get install opendkim libmail-dkim-perl</div></div></pre></div></figure>

<p>The second one is a dkim support for spamassassin. I’ll cover that later. Next,
you need to edit your <code class="highlighter-rouge">/etc/opendkim.conf</code> file:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">/etc/opendkim.conf</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">SysLog             yes
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">Umask              002
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">KeyTable           /etc/mail/dkim/KeyTable
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">SigningTable       /etc/mail/dkim/SigningTable
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">ExternalIgnoreList /etc/mail/dkim/TrustedHosts
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">InternalHosts      /etc/mail/dkim/TrustedHosts
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">Canonicalization   relaxed/simple
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">Mode               sv
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">X-Header           yes</div></div></pre></div></figure>

<p><code class="highlighter-rouge">Mode sv</code> directive tells opendkim to sign but also verify messages, while
<code class="highlighter-rouge">X-Header</code> adds <code class="highlighter-rouge">X-Dkim</code> header (which contains information about the DKIM
daemon you are using). Next we need to tell opendkim which port it will be
using, so in <code class="highlighter-rouge">/etc/default/opendkim</code> uncomment:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">/etc/default/opendkim</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nv">SOCKET</span><span class="o">=</span><span class="s2">"inet:12345@localhost"</span> <span class="c"># listen on loopback on port 12345</span></div></div></pre></div></figure>

<p>Now we have to populate those extra files we defined. <code class="highlighter-rouge">TrustedHosts</code> is the
easiest one, it’s just the list of hosts and domains which are allowed to use
DKIM. So in most cases:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">/etc/mail/dkim/TrustedHosts</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">localhost
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">127.0.0.1
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">192.168.1.1
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">1.2.3.4 <span class="c"># external IP</span></div></div></pre></div></figure>

<p>Next, we need to create a key and DNS TXT record pair for each domain we want
to be signed. I suggest to use strong key (<code class="highlighter-rouge">-b</code> parameter), to avoid
<a href="http://www.wired.com/threatlevel/2012/10/dkim-vulnerability-widespread">some company’s failure</a>.
To do this:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">As root</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">mkdir -p /etc/mail/dkim/keys/mydomain.com
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nb">cd</span> /etc/mail/dkim/keys/mydomain.com
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">opendkim-genkey -r -b 2048 -d mydomain.com -s mail
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">chown opendkim:opendkim mail.private
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">chmod 600 mail.private</div></div></pre></div></figure>

<p>This will create two files: <code class="highlighter-rouge">mail.private</code> - which contains a private RSA key,
and <code class="highlighter-rouge">mail.txt</code> which contains a contents for DNS TXT record. So let’s make use
of them! First keys - they need to be fined in <code class="highlighter-rouge">KeyTable</code> and <code class="highlighter-rouge">SingingTable</code>
files.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">/etc/mail/dkim/KeyTable</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">mail._domainkey.mydomain.com mydomain.com:mail:/etc/mail/dkim/keys/mydomain.com/mail.private</div></div></pre></div></figure>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">/etc/mail/dkim/SigningTable</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">mydomain.com mail._domainkey.mydomain.com</div></div></pre></div></figure>

<p>The last thing we need to do is to add a DNS TXT record for
<code class="highlighter-rouge">mail._domainkey.mydomain.com</code> domain containing contents provided by
<code class="highlighter-rouge">opendkim-genkey</code>. For example for irgon.com it looks like this:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">DNS TXT record</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">mail._domainkey.irgon.com descriptive text <span class="s2">"v=DKIM1</span><span class="se">\;</span><span class="s2"> g=*</span><span class="se">\;</span><span class="s2"> k=rsa</span><span class="se">\;</span><span class="s2"> p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAsfIThdXoizR6sop0gifPwPkT45I/KnTTNKDS4BHWtoU6as62c/3BRQuKqDAIacheZzWbfEPq/M2YvoNrVhx1laltg7aeUhZlcVOtz415lIy8M8oUVTCDxewBKsTEQD5M4Roaadoj7vzpA1JMcOEv36TizFq/KB5GL46pVNyOMJ+Mg"</span> <span class="s2">"97F+EQQeiOFsn/T+tNuxWky3l4Qky3S8U34wYmRSr+sVLu4U31QtocwL4uJ7ofVNdVk0baYo7s1HYnM3CGEKK+zdHTR/AoNiquvVX1lLX9s85bade4cNuRaINjzDyM4fAglLgSHZEtRcRlYqdMEpQcplI1OaSxIFS4DpFL3RwIDAQAB"</span></div></div></pre></div></figure>

<p>And that settles DKIM. All we have left is starting it:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">As root</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">/etc/init.d/opendkim start</div></div></pre></div></figure>

<h2 id="connecting-opendkim-to-postfix">Connecting opendkim to postfix</h2>

<p>This is really simple part.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">/etc/postfix/main.cf</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c"># DKIM</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">milter_default_action <span class="o">=</span> accept
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">milter_protocol <span class="o">=</span> 6
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">smtpd_milters <span class="o">=</span> inet:localhost:12345
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">non_smtpd_milters <span class="o">=</span> inet:localhost:12345</div></div></pre></div></figure>

<p>then. reload it and you are set.</p>

<h2 id="installing-spf">Installing SPF</h2>

<p>Ok, now THAT is simple. Just install package:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">As root</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">apt-get install postfix-policyd-spf-python</div></div></pre></div></figure>

<p>and add service:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">/etc/postfix/master.cf</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">policy-spf  unix  -  n  n  -  -  spawn <span class="nv">user</span><span class="o">=</span>nobody <span class="nv">argv</span><span class="o">=</span>/usr/bin/policyd-spf</div></div></pre></div></figure>

<p>Add spf timeout to <code class="highlighter-rouge">/etc/postfix/main.cf</code> and adjust
<code class="highlighter-rouge">smtpd_recipient_restrictions</code> to include
<code class="highlighter-rouge">check_policy_service unix:private/policy-spf</code>, so in my file it looks like
this:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">/etc/postfix/main.cf</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="o">[</span>...]
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">smtpd_recipient_restrictions <span class="o">=</span> reject_unauth_pipelining,
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">                               permit_sasl_authenticated,
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">                               permit_mynetworks,
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">                               reject_non_fqdn_recipient,
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">                               reject_unknown_recipient_domain,
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">                               reject_unauth_destination,
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">                               reject_unknown_sender_domain,
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">                               check_policy_service unix:private/policy-spf
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="o">[</span>...]
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">spf-policyd_time_limit <span class="o">=</span> 3600s</div></div></pre></div></figure>

<p>Last but not least is updating a DNS record. This is simple and similar to DKIM -
just ad TXT record to your TLD containing <code class="highlighter-rouge">v=spf1 a mx ip4:&lt;your ip&gt;</code>, for
example my looks like this:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">DNS TXT record</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">irgon.com descriptive text <span class="s2">"v=spf1 a mx ip4:213.134.188.213"</span></div></div></pre></div></figure>

<p>Don’t forget to restart your Postfix when you’re done!</p>

<h2 id="testing">Testing</h2>

<p>To test if everything works fine, just send yourself an email and check it
headers. You should see something like:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">Mail header</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">X-Dkim: OpenDKIM Filter v2.0.1 myexample.com 0224020B8
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">Dkim-Signature: <span class="nv">v</span><span class="o">=</span>1; <span class="nv">a</span><span class="o">=</span>rsa-sha256; <span class="nv">c</span><span class="o">=</span>relaxed/simple; <span class="nv">d</span><span class="o">=</span>myexample.com; <span class="nv">s</span><span class="o">=</span>mail; <span class="nv">t</span><span class="o">=</span>1351357546; <span class="nv">bh</span><span class="o">=</span>Rskt6Q/nZKmxgXkWUYP6cCBSDJhtkVT0PSrUEVGVgp4<span class="o">=</span>; <span class="nv">h</span><span class="o">=</span>From:Content-Type:Content-Transfer-Encoding:Subject:Message-Id: Date:To:Mime-Version; <span class="nv">b</span><span class="o">=</span>phPQdG6HYaders4Xv0TsK2mT+PFYVk/brOFpnmCjCZtvbeGJ+XwrNk4Tnc9xGELtAglLOVplSvMV9nTK6xonta1qLTtnLYPsY4o/WPfyZYDgHmp6X9ZYP4otAHYK3jC00PbKGNqhXeD3bCc7CBV/aVGMQX4Bt0TjAAgndeYCI9VnvR2zH0iTEjlAT2OXrh2JV+wrK5UOXae8gRPT28F2Mg325YOiDwD1T5bgFtfc9mh2s/NRcy7lyDiPcb3CNV+nMXKyq/47o22LlALv5g5+OBBZACQYpYtgalM54InQDPoL/udvKtI/YYaiByFLwqeYFh2LXX6et 9dAiNCRLL+EoA<span class="o">==</span></div></div></pre></div></figure>

<p>Which means that singing is alive and kicking. To test verification, just send
yourself an email from DKIM-using provider (like Yahoo or Gmail) and check for
following header:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">Mail header</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">Authentication-Results: myexample.com; <span class="nv">dkim</span><span class="o">=</span>pass <span class="o">(</span>2048-bit key; insecure key<span class="o">)</span> header.i<span class="o">=</span>@gmail.com; dkim-adsp<span class="o">=</span>pass</div></div></pre></div></figure>

<p>Which means, that verfication is working. As the last final test, send email to
`autorespond+dkim@dk.elandsys.comz. This is automated service, which checks
your DKIM headers for you and sends back the results. If you get DKIM Signature
validation: passz in the body, then it means, that everything is working
properly.</p>

<h2 id="final-polishing">Final polishing</h2>

<p>By default spamassassin has DKIM filters enabled. To ensure, look for
<code class="highlighter-rouge">loadplugin Mail::SpamAssassin::Plugin::DKIM</code> in your
<code class="highlighter-rouge">/etc/spamassassin/v312.pre</code> file. When it’s enabled you should see values like
<code class="highlighter-rouge">DKIM_VALID</code> or <code class="highlighter-rouge">T_DKIM_INVALID</code> in <code class="highlighter-rouge">X-Spam-Status</code> header. Normally,
spamassassin puts a very little weight to that rules, but you can easily
increase it by adding:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">/etc/mail/spamassassin/local.cf</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">score T_DKIM_INVALID 10
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">score DKIM_ADSP_CUSTOM_MED 10</div></div></pre></div></figure>

<p>You can also add sieve filter based on <code class="highlighter-rouge">Authentication-Results</code> if you want to
treat those suspicious messages differently than normal spam:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">.dovecot.sieve</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">if </span>header :contains <span class="s2">"Authentication-Results"</span> <span class="s2">"dkim=fail"</span> <span class="o">&#x7b;</span> fileinto <span class="s2">"DANGER"</span>; stop; <span class="o">&#x7d;</span></div></div></pre></div></figure>

<p>The possibilities are endless :)</p>

<h3 id="sources">Sources</h3>

<ul>
  <li><a href="http://blog.tjitjing.com/index.php/2012/03/guide-to-install-opendkim-for-multiple-domains-with-postfix-and-debian.html">http://blog.tjitjing.com/index.php/2012/03/guide-to-install-opendkim-for-multiple-domains-with-postfix-and-debian.html</a></li>
  <li><a href="http://syslog.tv/2011/09/17/postfix-dk-dkim-spf/">http://syslog.tv/2011/09/17/postfix-dk-dkim-spf/</a></li>
</ul>

        </div>

        <div id="disqus_thread" class="comments-disqus"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES * * */
            var disqus_shortname = 'ajgon';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </div>
</div>


        <footer class="mdl-mega-footer">
  <div class="mdl-mega-footer__top-section mdl-grid">
    <div class="mdl-cell mdl-cell--4-col">
      <h5 class="headline">Open Source</h5>
      <ul class="mdl-mega-footer--link-list mdl-mega-footer--left-align" id="recent-tweets">
        <li><a href="http://opsworks-ruby.rzegocki.pl/" target="_blank">opsworks_ruby</a></li>
        <li><a href="https://github.com/ajgon/self-hosted-mailserver" target="_blank">self-hosted-mailserver</a></li>
        <li><a href="https://github.com/ajgon/lint-pack" target="_blank">LintPack</a></li>
        <li><a href="https://github.com/ajgon/chef-imagetragick" target="_blank">chef-imagetragick</a></li>
        <li><a href="https://github.com/ajgon/jquery-timer" target="_blank">jquery.timer</a></li>
      </ul>
    </div>
    <div class="mdl-cell mdl-cell--4-col">
      <h5 class="headline">Connect</h5>
      
        <a class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect" href="https://github.com/ajgon" id="connect_Q" target="_blank">
          <i class="material-icons socicon">Q</i>
        </a>
        <div for="connect_Q" class="mdl-tooltip">GitHub</div>
      
        <a class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect" href="https://linkedin.com/in/ajgon" id="connect_j" target="_blank">
          <i class="material-icons socicon">j</i>
        </a>
        <div for="connect_j" class="mdl-tooltip">LinkedIN</div>
      
        <a class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect" href="https://twitter.com/ajgon" id="connect_a" target="_blank">
          <i class="material-icons socicon">a</i>
        </a>
        <div for="connect_a" class="mdl-tooltip">Twitter</div>
      
        <a class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect" href="https://keybase.io/ajgon" id="connect_vpn_key" target="_blank">
          <i class="material-icons">vpn_key</i>
        </a>
        <div for="connect_vpn_key" class="mdl-tooltip">Keybase</div>
      
    </div>
    <div class="mdl-cell mdl-cell--4-col">
      <h5 class="headline">Contact</h5>
      <ul class="mdl-mega-footer--link-list">
        <li>
            Mail: <span class="codedirection">&#108;&#112;.&#105;&#107;&#99;&#111;&#103;&#101;&#122;&#114;@&#114;&#111;&#103;&#105;
        </li>
        <li>
          Skype: <a href="skype:igor.rzegocki">igor.rzegocki</a>
        </li>
      </ul>
    </div>
  </div>
  <div class="mdl-mega-footer__bottom-section">
    Copyright &copy; 2015-2017 - <a href="/avatar.html">Igor Rzegocki</a> - Powered by <a href="http://octopress.org/" target="_blank">Octopress</a>.
    Previous version of the site, available <a href="/v3">here</a>.
  </div>
</footer>

      </main>
    </div>

    <script type="text/javascript" src="/assets/main-2e8afb635e8655d0a53ed975550ec87e8de97e5f6ff771877f1d5c2db44dcf16.js"></script>

<script>
  window['GoogleAnalyticsObject'] = 'ga';
  ga('create', 'UA-65616575-1', 'auto');
  ga('send', 'pageview');
</script>

  </body>

</html>
